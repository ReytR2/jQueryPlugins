/**
 * @file   : Ptty.jquery.min.js
 * @ver    : 0.1
 * @Author : Patxi Pierce
 * @url    : http://code.patxipierce.com/jquery-plugin/ptty/
 * @desc   : Ptty (Pachanka's teletype). A terminal emulator plugin for jQuery. 
 *           Based on wterm.js by Venkatakrishnan Ganesh.
 * @license: Copyright 2014 Patxi Pierce <mail@patxipierce.com>
 *           This work is free. You can redistribute it and/or modify it under the
 *           terms of the Do What The Fuck You Want To Public License, Version 2,
 *           as published by Sam Hocevar. See the COPYING file for more details.
 **/
(function(e){var t="0.0.1";var n=function(){return{url:window.location.pathname,method:"POST",param:"cmd",tty_class:"cmd_terminal",ps:"",theme:"boring",width:"100%",height:"100%",welcome:"Ptty v."+t,placeholder:"*",not_found:"<div> CMD: Command Not Found </div>",error_prefix:"An Error Occured: ",autocomplete:true,history:true,history_max:800}};var r={};var s={};var o=[];var u={cmd_name:null,cmd_class:null,cmd_ps:null,cmd_in:null,cmd_out:null,cmd_quiet:null,cmd_token:null,cmd_query:null};var a=function(t){var s=n();e.extend(true,s,t);e.register_command("clear","Cleans the screen leaving a new command prompt ready.","clear [no options]",function(){e("."+s.tty_class+"_content").html("");return{type:"print",out:"",quiet:"clear"}});e.register_command("history","Shows list of typed in commands.","history [no options]",function(){var e="";if(s.history&&o.length>0){var t,n;for(t in o){n=o[t];e+="<li>"+n+"</li>"}e='<ul class="ve-li">'+e+"</ul>"}return{type:"print",out:e}});e.register_command("help","Displays a list of useful information.","help [ [-a | --all] | [command] ]",function(t){var n="";if(typeof t[1]==="string"&&t[1].length>0){var s=e.trim(t[1]);if(s=="-a"||s=="--all"){n='Available commands are:</br><ul class="ve-li">';for(i in r){n+="<li><p><b>"+i+"</b> - "+r[i].desc+"</br>";n+="Usage: "+r[i].usage+"</p></li>"}n+="</ul>"+"\n"}else if(typeof r[s]!=="undefined"){n="<b>"+s+"</b> - "+r[s].desc+"</br>";n+="Usage: "+r[s].usage+"\n"}else{n='help:</br>The "'+s+'" option does not exist.'+"\n"}}else{n='Use "help [comand name]" to display specific info about a command.</br>'+"\n";n+='Available commands are:</br><ul class="sq-li">';for(i in r){n+="<li>"+i+"</li>"}n+="</ul>"+"\n"}return{type:"print",out:n}})};e.fn.Ptty=function(t){var f=n();e.extend(true,f,t);return this.each(function(){var n=e(this);var l=null;n.addClass(f.tty_class).addClass(f.tty_class+"_theme_"+f.theme);if(f.width&&f.height){n.css({width:f.width,height:f.height})}n.html("").append('<div class="'+f.tty_class+'_loading"><span></span></div>');n.append('<div class="'+f.tty_class+'_content"><div>'+f.welcome+"</div></div>");n.append('<div class="'+f.tty_class+'_prompt"><span class="'+f.tty_class+'_ps">'+'<span class="'+f.tty_class+'_active">'+f.ps+"</span>&nbsp;</span>"+'<form><input type="text" /><input type="password" /></form></div>');var c=n.find("div:last span:last");var h=n.find("div:last form");var p=h.find("input");var d=h.find("input[type=text]");var v=h.find("input[type=password]");var m=n.find("div."+f.tty_class+"_content");var g=n.find("div."+f.tty_class+"_loading");var y=null;var b={ac_save:null,h_save:null};e(function(){d.focus()});n.bind("select focus click",function(){if(d.is(":visible")){d.focus()}else if(v.is(":visible")){v.focus()}});a(t);var w=function(e,t,n){var r=command_class=ps=null;var i=output=quiet=token=query=null;var s,o;for(s in u){o=u[s];if(o!==null){switch(s){case"cmd_name":r=o;break;case"cmd_class":command_class=o;break;case"cmd_ps":ps=o;break;case"cmd_in":i=o;break;case"cmd_out":output=o;break;case"cmd_quiet":quiet=o;break;case"cmd_token":token=o;break;case"cmd_query":query=o;break}}u[s]=null}u.cmd_name=r;u.cmd_token=token;u.cmd_query=query;u.cmd_ps=ps;u.cmd_class=y?f.tty_class+"_sub":f.tty_class+"_ps";if(command_class===null)command_class=u.cmd_class;if(output)n=output;if(i!==null)t=i;if(quiet=="clear"){m.html("");e=""}else if(quiet=="password"){e='<span class="'+command_class+'"><span>'+e+"</span>&nbsp;"+Array(t.length+1).join(f.placeholder)+"</span>"}else if(quiet=="blank"){e='<span class="'+command_class+'"><span>'+e+"</span>&nbsp;</span>"}else{e='<span class="'+command_class+'"><span>'+e+"</span>&nbsp;"+t+"</span>"}m.append("<div>"+e+"<div>"+n+"</div></div>");g.fadeOut(300);c.show()};var E=function(){return u.cmd_ps!==null?u.cmd_ps:f.ps};var S=function(){return u.cmd_ps?c.html(u.cmd_ps):c.html(f.ps)};var x=function(t,n,i){var s={cmd:n};if(u.cmd_query!==null){s["cmd_query"]=u.cmd_query;s["cmd"]=u.cmd_in}if(u.cmd_token!==null){s["cmd_token"]=u.cmd_token}if(i===false||i==""||typeof i==="undefined"){i=r[t].type_of?r[t].type_of:f.url}e.ajax({type:f.method,url:i,data:s}).done(function(e){e["ajax_url"]=i;e=e||"";A(n,e)}).fail(function(){w(E(),n,"<div>"+f.error_prefix+" Invalid server response. </div>")})};var T=function(e,t,n,i){if(e==""){w(E(),t,"")}else if(y!==null){k(e,t,n)}else if(typeof r[e]==="undefined"){w(E(),t,f.not_found.replace("CMD",n[0]))}else if(typeof r[e].type_of==="object"){k(e,t,n)}else if(typeof r[e].type_of==="string"){x(e,t,i)}else if(typeof r[e].type_of==="function"){L(r[e].type_of,n,t)}else{x(e,t,f.url)}};var N=function(e){y=r[e].type_of;c.html(y.ps);n.find("div:last span:first").toggleClass(f.tty_class+"_ps "+f.tty_class+"_sub");u.cmd_ps="";u.cmd_name=e;u.cmd_class=f.tty_class+"_ps";b.ac_save=f.autocomplete;f.autocomplete=false;b.h_save=o;o=[]};var C=function(){c.html("");n.find("div:last span:first").toggleClass(f.tty_class+"_ps "+f.tty_class+"_sub");u.cmd_class=f.tty_class+"_sub";u.cmd_name=null;u.cmd_token=null;u.cmd_query=null;u.cmd_ps=null;f.autocomplete=b.ac_save?b.ac_save:false;o=b.h_save?b.h_save:[];y=null};var k=function(e,t,n){var r=f.url;if(y==null){N(e);r=y.start_hook}else if(y){if(e=="quit"||e=="exit"){r=y.exit_hook;C()}else{r=y.dispatch_method}}if(typeof r==="string"){x(e,t,r)}else if(typeof r==="function"){L(r,n,t)}};var L=function(e,t,n){return A(n,e(t))};var A=function(e,t){var n={ps:E(),output:""};if(typeof t.ps!=="undefined"){u.cmd_ps=t.ps}else{n.ps=u.cmd_ps!==null?u.cmd_ps:f.ps;u.cmd_ps=y!==null?y.ps:f.ps}S();if(typeof t.in!=="undefined"){u.cmd_in=t.in}if(typeof t.out!=="undefined"){u.cmd_out=t.out}if(typeof t.quiet!=="undefined"){if(t.quiet=="password"){u.cmd_quiet="password"}else if(t.quiet=="blank"){u.cmd_quiet=true}else if(t.quiet=="clear"){u.cmd_quiet="clear"}else{u.cmd_quiet=null}}if(typeof t.token!=="undefined"){u.cmd_token=t.token}if(typeof t.query!=="undefined"){u.cmd_query=t.query}if(typeof t.exit!=="undefined"&&y){C()}if(typeof t.type!=="undefined"){switch(t.type){case"prompt":if(!u.cmd_token){var r=Math.random().toString(36).substr(2),i=Math.random().toString(36).substr(2),o=Math.random().toString(36).substr(2);u.cmd_token=r+i+o}break;case"password":d.hide();v.show().focus();break;default:t.type="print";break}}w(n.ps,e,n.output);if(typeof t.callback!=="undefined"){try{if(typeof s[t.callback]==="function"){n.output=s[t.callback](t)}else{throw f.error_prefix+" No callback called "+t.callback}}catch(a){}}};var O=function(){var e=0,t=new_height=n.height();var r=setInterval(function(){if(t!=new_height){clearInterval(r);n.animate({scrollTop:new_height},"slow")}else if(e>=30){clearInterval(r);n.animate({scrollTop:new_height},"slow")}else{new_height=m.height();e++}},50)};h.submit(function(t){t.preventDefault();t.stopPropagation();var n=e.trim(e("<div/>").text(d.val()).html());if(v.val().length){n=v.val();v.val("")}u.cmd_in=n;if(u.cmd_query!==null){n=u.cmd_query+n}var i=n.split(/\s+/);var s=i[0];if(f.history&&typeof r[s]!=="undefined"){if(o.length>f.history_entries){o.shift()}if(u.cmd_quiet===null||y){o.push(e.trim(n))}}g.show();c.hide();T(s,n,i);d.val("");d.focus();O()});d.keydown(function(t){var n=t.keyCode;switch(n){case 9:t.preventDefault();if(f.autocomplete){var s=[];var u=e.trim(d.val());if(u.match(/^[^\s]{0,}$/)){for(i in r){if(u==""){s.push(i)}else if(i.indexOf(u)==0){s.push(i)}}if(s.length>1){w(E(),u,'<ul class="sq-li"><li>'+s.join("</li><li>")+"</li></ul>")}else if(s.length==1){d.val(s.pop()+" ")}}}O();break;case 38:t.preventDefault();if(f.history){l=l===null?o.length-1:l==0?o.length-1:l-1;d.val(o[l])}break;case 40:t.preventDefault();if(f.history){if(l===null||l==o.length-1){d.val("");break}l++;d.val(o[l])}break;case 13:t.preventDefault();h.submit();O();d.focus();break}});v.keydown(function(e){if(v.is(":visible")){var t=e.keyCode;switch(t){case 13:e.preventDefault();h.submit();v.hide();d.show();O();d.focus();break}}});e(document).keydown(function(e){var t=e.keyCode;switch(t){case 27:if(d.is(":visible")){d.focus()}else if(v.is(":visible")){v.focus()}break}})})};e.register_command=function(e,t,n,i){try{if(typeof i==="string"||typeof i==="object"||typeof i==="function"){r[e]={desc:t,usage:n,type_of:i}}else{throw"Dispatch needs to be a string, object or function"}}catch(s){}};e.register_callback=function(e,t){try{if(typeof t==="string"||typeof t==="object"||typeof t==="function"){s[e]=t}else{throw"Callback needs to be a method"}}catch(n){}};e.flush_commands=function(t){r={};e.set_command_option(t);a(t)};e.set_command_option=function(t){e.extend(true,u,t)}})(jQuery)
